<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket JSON Reader</title>
    <style>
/* Estilo para os elementos <pre> que exibem os dados JSON */
        pre {
            width: calc(20% - 20px);
            float: left;
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 5px #ccc;
            overflow: auto;
            transition: box-shadow 0.3s;
        }

        /* Estilo para realçar o bloco quando uma mensagem for recebida */
        pre.received-message {
            animation: pulse 1s;
        }

        /* Animação para destacar o bloco */
        @keyframes pulse {
            0% { box-shadow: 0 0 5px #ccc; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #ccc; }
        }

        /* Estilo para o cabeçalho */
        h1 {
            clear: both;
            text-align: center;
            margin-top: 20px;
        }
    </style>
  </head>
  <body>
    <div id="connect-form">
      Número de nós:
      <input id="num-nodes" value="10">
      <button id="connect-btn">Conectar</button>
    </div>

    <div id="control-form" hidden>
      <div>
        Nó selecionado:
        <input id="node-id" value="1">
        <button id="sync-crdt-btn">SYNC</button>
      </div>

      <div>
        <input id="table-name" placeholder="Table">
        <button id="create-table-btn">Criar Tabela</button>
        <button id="delete-table-btn">Deletar Tabela</button>
      </div>

      <div>
        <input id="doc-id" placeholder="Document ID">
        <input id="doc-value" placeholder="Valor">
        <button id="put-doc-btn">PUT</button>
        <button id="patch-doc-btn">PATCH</button>
        <button id="delete-doc-btn">DELETE</button>
      </div>

      <div id="errors" style="color: red;">
      </div>
    </div>

    <div id="outputs">
    </div>

    <script>
      const websockets = [];
      
      async function sendHTTPMessage(nodeID, method, path, message) {
        const port = 3000 + nodeID;

        let body;
        if (message !== null) {
          body = JSON.stringify(message);
        }

        const resp = await fetch('http://localhost:'+port+path, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
          },
          body: body,
        });

        if (resp.status === 200) {
          document.getElementById('errors').textContent = '';
          return await resp.json();
        } else {
          const text = await resp.text();
          document.getElementById('errors').textContent = 'Erro: ' + text;
        }
      }

      document.getElementById('connect-btn').addEventListener('click', () => {
        const numNodes = parseInt(document.getElementById('num-nodes').value);

        document.getElementById('connect-form').remove();
        document.getElementById('control-form').hidden = false;

        for (let i = 1; i < (1+numNodes); i++) {
          const outputElement = document.createElement('pre');
          outputElement.id = `output-${i}`;
          document.getElementById('outputs').appendChild(outputElement);
        }

        for (let i = 1; i < (1+numNodes); i++) {
          connectWebSocket(i);
        }
      });

      document.getElementById('sync-crdt-btn').addEventListener('click', () => {
        const nodeID = parseInt(document.getElementById('node-id').value);
        sendHTTPMessage(nodeID, 'PUT', '/crdt_sync', null).catch(console.error);
      });

      document.getElementById('create-table-btn').addEventListener('click', () => {
        const nodeID = parseInt(document.getElementById('node-id').value);
        const tableName = document.getElementById('table-name').value;
        sendHTTPMessage(nodeID, 'PUT', '/db/'+tableName, {strong_consistency: false}).catch(console.error);
      });

      document.getElementById('delete-table-btn').addEventListener('click', () => {
        const nodeID = parseInt(document.getElementById('node-id').value);
        const tableName = document.getElementById('table-name').value;
        sendHTTPMessage(nodeID, 'DELETE', '/db/'+tableName, null).catch(console.error);
      });

      document.getElementById('put-doc-btn').addEventListener('click', () => {
        const nodeID = parseInt(document.getElementById('node-id').value);
        const tableName = document.getElementById('table-name').value;
        const docID = document.getElementById('doc-id').value;
        const docValue = document.getElementById('doc-value').value;
        sendHTTPMessage(nodeID, 'PUT', '/db/'+tableName+'/'+docID, JSON.parse(docValue)).catch(console.error);
      });

      document.getElementById('patch-doc-btn').addEventListener('click', () => {
        const nodeID = parseInt(document.getElementById('node-id').value);
        const tableName = document.getElementById('table-name').value;
        const docID = document.getElementById('doc-id').value;
        const docValue = document.getElementById('doc-value').value;
        sendHTTPMessage(nodeID, 'PATCH', '/db/'+tableName+'/'+docID, JSON.parse(docValue)).catch(console.error);
      });

      document.getElementById('delete-doc-btn').addEventListener('click', () => {
        const nodeID = parseInt(document.getElementById('node-id').value);
        const tableName = document.getElementById('table-name').value;
        const docID = document.getElementById('doc-id').value;
        sendHTTPMessage(nodeID, 'DELETE', '/db/'+tableName+'/'+docID, null).catch(console.error);
      });

      function refreshState(nodeID) {
        sendHTTPMessage(nodeID, 'GET', '/db', null).then((data) => {
          const outputElement = document.getElementById(`output-${nodeID}`);
          const formattedJson = JSON.stringify(data, null, 2);
          outputElement.textContent = `Node ${nodeID}\n`+formattedJson;
        }).catch(console.error);
      }

      function connectWebSocket(nodeID) {
        const port = 3000 + nodeID;
        const ws = new WebSocket(`ws://localhost:${port}/ws`);

        refreshState(nodeID);

        // Quando uma mensagem for recebida na conexão
        ws.onmessage = (event) => {
          console.log(`Received message from node ${nodeID}: ${event.data}`);
          const jsonData = JSON.parse(event.data);
          const formattedJson = JSON.stringify(jsonData, null, 2);
          const outputElement = document.getElementById(`output-${nodeID}`);

          // Adicionar a classe para destacar o bloco ao receber uma mensagem
          outputElement.classList.add('received-message');

          refreshState(nodeID);

          // Remover a classe após alguns segundos para remover o destaque
          setTimeout(() => {
            outputElement.classList.remove('received-message');
          }, 1000);
        };

        // Adicionar a conexão WebSocket ao array de conexões
        websockets.push(ws);
      }
    </script>
  </body>
</html>
